---
phase: 05-suggestion-engine-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/actions.ts
  - src/lib/hooks/use-celebration.ts
  - src/components/weekend/work-item-row.tsx
autonomous: true

must_haves:
  truths:
    - "Marking the final core work item of a weekend triggers a confetti celebration"
    - "Confetti does NOT fire when toggling a single checkbox (only on weekend completion transition)"
    - "Confetti does NOT fire when unchecking a box on an already-completed weekend"
    - "Confetti respects prefers-reduced-motion (disableForReducedMotion: true)"
    - "motion and canvas-confetti packages are installed and available"
  artifacts:
    - path: "src/lib/hooks/use-celebration.ts"
      provides: "useCelebration hook returning celebrate function"
      exports: ["useCelebration"]
    - path: "src/lib/actions.ts"
      provides: "toggleWorkItem returning { weekendJustCompleted: boolean }"
      exports: ["toggleWorkItem"]
    - path: "src/components/weekend/work-item-row.tsx"
      provides: "WorkItemRow triggering confetti on weekend completion"
  key_links:
    - from: "src/components/weekend/work-item-row.tsx"
      to: "src/lib/actions.ts"
      via: "toggleWorkItem return value checked for weekendJustCompleted"
      pattern: "weekendJustCompleted"
    - from: "src/components/weekend/work-item-row.tsx"
      to: "src/lib/hooks/use-celebration.ts"
      via: "useCelebration hook called to trigger confetti"
      pattern: "useCelebration"
    - from: "src/lib/hooks/use-celebration.ts"
      to: "canvas-confetti"
      via: "dynamic import of canvas-confetti"
      pattern: "import.*canvas-confetti"
---

<objective>
Install animation dependencies and implement the completion celebration flow -- confetti burst when a weekend transitions from incomplete to complete.

Purpose: The celebration is the emotional reward for completing a weekend. It must fire at exactly the right moment (all core items just completed) and never at the wrong moment (toggling random items, unchecking).
Output: motion + canvas-confetti installed, toggleWorkItem returns completion transition info, WorkItemRow triggers confetti.
</objective>

<execution_context>
@/Users/vladimirtsoy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladimirtsoy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-suggestion-engine-polish/05-RESEARCH.md

@src/lib/actions.ts
@src/components/weekend/work-item-row.tsx
@src/lib/hooks/use-debounce.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install motion and canvas-confetti packages</name>
  <files>package.json</files>
  <action>
Run:
```bash
npm install motion canvas-confetti
npm install -D @types/canvas-confetti
```

This installs:
- `motion` (12.x) -- the animation library (formerly framer-motion), needed for Plan 03 animations and used here as a project dependency
- `canvas-confetti` (1.9.x) -- lightweight confetti effects, zero runtime dependencies
- `@types/canvas-confetti` -- TypeScript types for canvas-confetti

Do NOT install `@number-flow/react` yet -- per research recommendation, start without it and add as a polish pass if needed.
  </action>
  <verify>Run `npm ls motion canvas-confetti` to confirm both packages are installed. Run `npx tsc --noEmit` to confirm no type errors.</verify>
  <done>motion and canvas-confetti are in package.json dependencies. @types/canvas-confetti is in devDependencies. No type errors.</done>
</task>

<task type="auto">
  <name>Task 2: Modify toggleWorkItem to return completion transition and wire celebration</name>
  <files>src/lib/actions.ts, src/lib/hooks/use-celebration.ts, src/components/weekend/work-item-row.tsx</files>
  <action>
**Modify `src/lib/actions.ts` -- toggleWorkItem function:**

The current `toggleWorkItem` returns `void`. Modify it to return `{ weekendJustCompleted: boolean }`:

1. After toggling the work item and computing `allCoreCompleted`, check if the weekend was previously completed:
```typescript
const [weekend] = await db
  .select({ completedAt: weekends.completedAt })
  .from(weekends)
  .where(eq(weekends.id, updated.weekendId));

const wasAlreadyCompleted = weekend?.completedAt !== null;
const weekendJustCompleted = allCoreCompleted && !wasAlreadyCompleted;
```

2. After updating the weekend `completedAt`, return the result:
```typescript
return { weekendJustCompleted };
```

3. Update the early return (when `!updated`) to: `return { weekendJustCompleted: false };`

Keep all existing behavior (revalidatePath calls, etc.) unchanged. Only add the return value.

**Create `src/lib/hooks/use-celebration.ts`:**

A Client Component hook that dynamically imports canvas-confetti to avoid SSR issues:

```typescript
"use client";

import { useCallback } from "react";

export function useCelebration() {
  const celebrate = useCallback(async () => {
    const confetti = (await import("canvas-confetti")).default;

    const defaults = {
      disableForReducedMotion: true,
      zIndex: 9999,
    };

    // Fire from both sides for dramatic effect
    confetti({
      ...defaults,
      particleCount: 40,
      spread: 55,
      origin: { x: 0.3, y: 0.6 },
    });
    confetti({
      ...defaults,
      particleCount: 40,
      spread: 55,
      origin: { x: 0.7, y: 0.6 },
    });
  }, []);

  return celebrate;
}
```

Key details:
- Dynamic import ensures no SSR crash ("document is not defined")
- `disableForReducedMotion: true` respects accessibility
- Two-sided burst (x: 0.3 and x: 0.7) for dramatic but not excessive effect
- `particleCount: 40` per side (80 total) -- under 100 threshold for mobile performance
- `zIndex: 9999` ensures confetti is above all content

**Modify `src/components/weekend/work-item-row.tsx`:**

1. Import `useCelebration` from `@/lib/hooks/use-celebration`
2. Call `const celebrate = useCelebration()` in the component
3. Update `handleToggle` to check the return value of `toggleWorkItem`:

```typescript
function handleToggle() {
  startTransition(async () => {
    setOptimisticCompleted(!optimisticCompleted);
    const result = await toggleWorkItem(id);
    if (result?.weekendJustCompleted) {
      celebrate();
    }
  });
}
```

This ensures confetti ONLY fires when:
- The toggle was successful (result exists)
- The weekend just transitioned from incomplete to complete
- NOT when unchecking an item on a completed weekend
- NOT when toggling random non-final items
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. On the detail page, toggle individual checkboxes -- no confetti should fire
4. Complete the final unchecked core item of a weekend -- confetti should fire
5. Uncheck an item on a completed weekend -- no confetti
  </verify>
  <done>
Confetti fires exactly once when the last core work item is checked (weekend completion transition). Does not fire on any other toggle. Respects reduced-motion preferences. No SSR errors.
  </done>
</task>

</tasks>

<verification>
1. `npm ls motion canvas-confetti` shows both installed
2. `npx tsc --noEmit` passes
3. `npm run build` succeeds
4. Completing a weekend's final core item triggers double-sided confetti burst
5. Random checkbox toggles do not trigger confetti
6. Unchecking an item on a completed weekend does not trigger confetti
7. No "document is not defined" errors in build or SSR
</verification>

<success_criteria>
- motion and canvas-confetti packages installed
- toggleWorkItem returns { weekendJustCompleted } correctly
- useCelebration hook dynamically imports canvas-confetti
- WorkItemRow triggers confetti only on weekend completion transition
- Accessibility: confetti disabled for prefers-reduced-motion users
- Requirement UI-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-suggestion-engine-polish/05-02-SUMMARY.md`
</output>
