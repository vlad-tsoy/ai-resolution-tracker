---
phase: 06-visualization-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/queries.ts
  - src/components/ui/chart.tsx
  - src/components/weekend/score-trends-chart.tsx
  - src/app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "A grouped bar chart shows average scores across all completed weekends on the overview page"
    - "Each of the three 1-5 rating dimensions (Outcome Quality, Time Saved, Repeatability) appears as a distinct colored bar per weekend"
    - "The chart displays averages per rating dimension with numeric values visible in tooltips"
    - "The visualization shows no data / is hidden when zero weekends have been scored"
    - "The chart updates automatically when new weekends are completed and scored (no manual refresh of chart data)"
  artifacts:
    - path: "src/lib/queries.ts"
      provides: "getScorecardAverages aggregation query"
      contains: "getScorecardAverages"
    - path: "src/components/ui/chart.tsx"
      provides: "shadcn/ui chart utilities (ChartContainer, ChartConfig, etc.)"
      contains: "ChartContainer"
    - path: "src/components/weekend/score-trends-chart.tsx"
      provides: "Client Component grouped bar chart with Recharts"
      contains: "use client"
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Overview page with lazy-loaded chart section"
      contains: "dynamic"
  key_links:
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/lib/queries.ts"
      via: "getScorecardAverages() call in Server Component"
      pattern: "getScorecardAverages"
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/components/weekend/score-trends-chart.tsx"
      via: "next/dynamic lazy import with ssr: false"
      pattern: "dynamic.*score-trends-chart"
    - from: "src/components/weekend/score-trends-chart.tsx"
      to: "src/components/ui/chart.tsx"
      via: "ChartContainer and ChartTooltip imports"
      pattern: "ChartContainer"
---

<objective>
Build the score trends visualization that displays average ratings across completed weekends as a grouped bar chart on the overview page.

Purpose: Fulfills VIZ-01 (visual summary of scores), VIZ-02 (average scores per dimension), and VIZ-03 (updates as weekends are completed). This is the core deliverable of Phase 6 -- users can see their score trends at a glance.

Output: A Drizzle aggregation query, a shadcn/ui-powered Recharts bar chart component, and lazy-loaded chart section on the overview page.
</objective>

<execution_context>
@/Users/vladimirtsoy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladimirtsoy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visualization-production-hardening/06-RESEARCH.md
@src/db/schema.ts
@src/lib/queries.ts
@src/app/(dashboard)/page.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui chart component and add aggregation query</name>
  <files>
    src/components/ui/chart.tsx
    src/lib/queries.ts
  </files>
  <action>
1. Install the shadcn/ui chart component:
   ```bash
   npx shadcn@latest add chart
   ```
   This will install `recharts` as a dependency and create `src/components/ui/chart.tsx` with ChartContainer, ChartConfig, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent.

2. After installation, check which version of recharts was installed: `cat node_modules/recharts/package.json | grep version`. If it's v2.x, the chart.tsx should still work fine -- just note it.

3. Add `getScorecardAverages()` to `src/lib/queries.ts`. This uses Drizzle's SQL builder API (NOT the relational query API) for aggregation:

   ```typescript
   import { eq, isNotNull, sql } from "drizzle-orm";
   import { scorecardRatings, weekends } from "@/db/schema";

   export async function getScorecardAverages() {
     return db
       .select({
         weekendNumber: weekends.number,
         weekendName: weekends.name,
         criterion: scorecardRatings.criterion,
         avgRating: sql<number>`cast(avg(${scorecardRatings.rating}) as float)`,
       })
       .from(scorecardRatings)
       .innerJoin(weekends, eq(scorecardRatings.weekendId, weekends.id))
       .where(isNotNull(weekends.completedAt))
       .groupBy(weekends.number, weekends.name, scorecardRatings.criterion)
       .orderBy(weekends.number);
   }
   ```

   Add the necessary imports at the top of queries.ts. The `db` import already exists. Add `eq, isNotNull, sql` from `drizzle-orm` and `scorecardRatings, weekends` from `@/db/schema` (weekends is already imported, scorecardRatings is new).

   IMPORTANT: The existing queries use the relational API (`db.query.weekends.findMany()`). The new aggregation query must use the SQL builder API (`db.select().from()`) because the relational API does not support `avg()` or `groupBy()`.
  </action>
  <verify>
    - `src/components/ui/chart.tsx` exists and exports ChartContainer
    - `npx tsc --noEmit` passes (no type errors)
    - `grep "getScorecardAverages" src/lib/queries.ts` finds the function
  </verify>
  <done>
    - shadcn/ui chart component installed with recharts dependency
    - getScorecardAverages() function exists in queries.ts returning grouped averages per weekend per criterion
  </done>
</task>

<task type="auto">
  <name>Task 2: Build score trends chart component and integrate into overview page</name>
  <files>
    src/components/weekend/score-trends-chart.tsx
    src/app/(dashboard)/page.tsx
  </files>
  <action>
1. Create `src/components/weekend/score-trends-chart.tsx` as a Client Component ("use client"):

   - Define a `ChartConfig` for the three 1-5 criteria (NOT use_again which is binary 0/1):
     - `outcome_quality`: label "Outcome Quality", color "var(--chart-1)"
     - `time_saved`: label "Time Saved", color "var(--chart-2)"
     - `repeatability`: label "Repeatability", color "var(--chart-3)"

   - Accept `data` prop typed as the return type of getScorecardAverages (array of { weekendNumber, weekendName, criterion, avgRating })

   - Transform flat rows to grouped chart data:
     ```
     Input:  [{ weekendNumber: 1, criterion: "outcome_quality", avgRating: 4.2 }, ...]
     Output: [{ weekendLabel: "Wk 1", outcome_quality: 4.2, time_saved: 3.8, repeatability: 4.0 }, ...]
     ```
     Use a Map<number, Record<string, number | string>> to pivot rows. Filter OUT `use_again` rows (binary, does not belong on 1-5 scale chart).

   - Render using Recharts components composed with shadcn/ui chart utilities:
     - `ChartContainer` with `config={chartConfig}` and `className="min-h-[300px] w-full"`
     - `BarChart` with `data={chartData}`
     - `CartesianGrid vertical={false}` for clean horizontal grid lines
     - `XAxis dataKey="weekendLabel"` with tick styling
     - `YAxis domain={[0, 5]}` to fix the rating scale
     - `ChartTooltip content={<ChartTooltipContent />}` for themed tooltips
     - `ChartLegend content={<ChartLegendContent />}` for labeled legend
     - Three `Bar` components, one per criterion, with `fill="var(--color-{criterion})"` and `radius={4}` for rounded tops

   - Wrap the chart in a styled container with a heading like "Score Trends" and a subtitle like "Average ratings across completed weekends"

   - Export as default for dynamic import compatibility

2. Update `src/app/(dashboard)/page.tsx`:

   - Import `dynamic` from `next/dynamic`
   - Import `Skeleton` from `@/components/ui/skeleton`
   - Import `getScorecardAverages` from `@/lib/queries`

   - Add lazy-loaded chart component:
     ```tsx
     const ScoreTrendsChart = dynamic(
       () => import("@/components/weekend/score-trends-chart"),
       {
         ssr: false,
         loading: () => (
           <div className="space-y-3">
             <Skeleton className="h-6 w-48" />
             <Skeleton className="h-[300px] w-full rounded-lg" />
           </div>
         ),
       }
     );
     ```

   - In OverviewPage, call `const scoreData = await getScorecardAverages();`

   - After the WeekendGrid, conditionally render the chart section:
     ```tsx
     {scoreData.length > 0 && <ScoreTrendsChart data={scoreData} />}
     ```
     This ensures the chart only appears when at least one completed weekend has scores. It automatically updates as more weekends are scored (VIZ-03) because the page uses `force-dynamic` and fetches fresh data on every request.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (production build verifies dynamic import works)
    - The chart renders on localhost when at least one weekend has scorecard ratings
    - The chart is NOT visible when no weekends have scores
    - The chart loads lazily (separate chunk, not in initial page bundle)
  </verify>
  <done>
    - ScoreTrendsChart component renders grouped bar chart with 3 rating dimensions
    - Overview page conditionally shows chart below the weekend grid
    - Chart is lazy-loaded via next/dynamic with ssr: false and skeleton loading state
    - Tooltips show exact average values; legend labels all three criteria
    - Y-axis fixed at 0-5 scale; use_again excluded from chart
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. On the overview page, when at least one completed weekend has scorecard ratings, a grouped bar chart appears below the weekend grid
3. The chart shows one group of bars per completed/scored weekend, with 3 colored bars (Outcome Quality, Time Saved, Repeatability)
4. Hovering a bar shows a tooltip with the exact average rating
5. A legend below the chart labels each color/criterion
6. When no weekends have scores, the chart section does not appear
7. The chart bundle is code-split (not in the initial page JS bundle)
</verification>

<success_criteria>
- VIZ-01: Visual summary (grouped bar chart) shows scores across completed weekends
- VIZ-02: Average scores displayed per rating dimension (3 criteria with averages)
- VIZ-03: Chart updates automatically as weekends are completed and scored (force-dynamic + server query)
- Chart is lazy-loaded for performance (no impact on initial page load)
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualization-production-hardening/06-01-SUMMARY.md`
</output>
