---
phase: 04-weekly-scorecard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/weekend/rating-scale.tsx
  - src/components/weekend/use-again-toggle.tsx
  - src/components/weekend/scorecard-notes-editor.tsx
  - src/components/weekend/scorecard-section.tsx
  - src/components/weekend/weekend-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Completed weekends show a scorecard with ratings for Outcome Quality (1-5), Time Saved (1-5), Repeatability (1-5), and Use Again (Yes/No)"
    - "Scorecard ratings auto-save on change without requiring an explicit save action"
    - "Each scorecard includes a free-text field for notes that persists"
    - "Uncompleted weekends show the scorecard as locked/disabled with a message to complete core work items"
  artifacts:
    - path: "src/components/weekend/rating-scale.tsx"
      provides: "1-5 scale rating via ToggleGroup with optimistic UI and auto-save"
      min_lines: 30
    - path: "src/components/weekend/use-again-toggle.tsx"
      provides: "Yes/No toggle via Switch with optimistic UI and auto-save"
      min_lines: 20
    - path: "src/components/weekend/scorecard-notes-editor.tsx"
      provides: "Debounced auto-saving textarea for scorecard-specific notes with markdown preview"
      min_lines: 40
    - path: "src/components/weekend/scorecard-section.tsx"
      provides: "Container composing all four rating dimensions plus notes editor"
      min_lines: 30
    - path: "src/components/weekend/weekend-detail.tsx"
      provides: "Updated detail view with conditional scorecard rendering based on completion status"
      contains: "ScorecardSection"
  key_links:
    - from: "src/components/weekend/rating-scale.tsx"
      to: "src/lib/actions.ts"
      via: "imports saveRating Server Action and calls on ToggleGroup value change"
      pattern: "import.*saveRating.*from.*actions"
    - from: "src/components/weekend/use-again-toggle.tsx"
      to: "src/lib/actions.ts"
      via: "imports saveRating Server Action and calls on Switch toggle"
      pattern: "import.*saveRating.*from.*actions"
    - from: "src/components/weekend/scorecard-notes-editor.tsx"
      to: "src/lib/actions.ts"
      via: "imports saveScorecardNotes Server Action, debounced call on textarea change"
      pattern: "import.*saveScorecardNotes.*from.*actions"
    - from: "src/components/weekend/weekend-detail.tsx"
      to: "src/components/weekend/scorecard-section.tsx"
      via: "conditional render based on weekend.completedAt"
      pattern: "completedAt.*ScorecardSection"
---

<objective>
Build the scorecard UI components and integrate them into the weekend detail page.

Purpose: Deliver the user-facing scorecard feature -- four rating dimensions (three 1-5 scales + one Yes/No toggle), a free-text notes field, completion gating (locked for uncompleted weekends), and auto-save behavior on all interactions.

Output: Five component files (four new, one modified) that compose into a fully functional scorecard section on the weekend detail page.
</objective>

<execution_context>
@/Users/vladimirtsoy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladimirtsoy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-weekly-scorecard/04-01-SUMMARY.md
@src/components/weekend/weekend-detail.tsx
@src/components/weekend/notes-editor.tsx
@src/lib/actions.ts
@src/lib/queries.ts
@src/lib/hooks/use-debounce.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scorecard rating and toggle components</name>
  <files>src/components/weekend/rating-scale.tsx, src/components/weekend/use-again-toggle.tsx, src/components/weekend/scorecard-notes-editor.tsx</files>
  <action>
1. **Create `src/components/weekend/rating-scale.tsx`** -- Client Component for 1-5 scale rating:

   ```typescript
   'use client';
   ```

   Props: `weekendId: number`, `criterion: string`, `label: string`, `description?: string`, `currentValue: number | null`.

   Implementation:
   - Use `useOptimistic` for instant visual feedback: `const [optimisticValue, setOptimisticValue] = useOptimistic(currentValue)`
   - Use `useTransition` for pending state: `const [isPending, startTransition] = useTransition()`
   - Render a `Label` with the `label` prop text and an optional `description` in a muted paragraph
   - Render a `ToggleGroup` with `type="single"`, value set to `optimisticValue?.toString() ?? ''`
   - Map `[1, 2, 3, 4, 5]` into `ToggleGroupItem` elements, each with `value={n.toString()}`, `aria-label={\`${label}: ${n} out of 5\`}`, and `className="w-10 h-10 data-[state=on]:bg-primary data-[state=on]:text-primary-foreground"`
   - **Deselection guard:** In `onValueChange`, check `if (!value) return;` before processing
   - On value change: `startTransition(async () => { setOptimisticValue(numValue); await saveRating(weekendId, criterion, numValue); })`
   - Apply `isPending ? 'opacity-70' : ''` to the ToggleGroup for visual pending feedback

2. **Create `src/components/weekend/use-again-toggle.tsx`** -- Client Component for Yes/No toggle:

   ```typescript
   'use client';
   ```

   Props: `weekendId: number`, `currentValue: number | null` (1=Yes, 0=No, null=unset).

   Implementation:
   - Use `useOptimistic` and `useTransition` same pattern as RatingScale
   - Render a `Label` with "Use Again?" text
   - Render a `Switch` with `checked={optimisticValue === 1}`, `onCheckedChange` handler
   - Show "Yes" / "No" text indicator next to the switch based on optimistic value (show nothing for null/unset)
   - On toggle: convert `checked` boolean to 1 or 0, then `startTransition(async () => { setOptimisticValue(numValue); await saveRating(weekendId, 'use_again', numValue); })`
   - Layout: flex row with `justify-between`, label on left, switch + indicator on right

3. **Create `src/components/weekend/scorecard-notes-editor.tsx`** -- Client Component for scorecard notes:

   Follow the EXACT same pattern as the existing `NotesEditor` component at `src/components/weekend/notes-editor.tsx`, with these differences:
   - Import `saveScorecardNotes` instead of `saveNotes` from `@/lib/actions`
   - Props: `weekendId: number`, `initialNotes: string | null`
   - Section heading: "Scorecard Notes" (not "Notes")
   - Placeholder text: "Best prompt, approach, what didn't work... (markdown supported)"
   - Use `rows={4}` instead of `rows={6}` (scorecard notes are typically shorter)
   - Include the same markdown preview section with the same `Markdown` component and styled components
   - Include the same save status indicator ("Saving..." / "Saved")
   - Use `useDebouncedCallback` with 1000ms delay, same as NotesEditor

**Important patterns:**
- All three components use `'use client'` directive
- RatingScale and UseAgainToggle save immediately on click (no debounce) via `useTransition` + `useOptimistic`
- ScorecardNotesEditor uses debounced save (1000ms) for text input, same as Phase 3's NotesEditor
- Import paths: `@/components/ui/toggle-group`, `@/components/ui/switch`, `@/components/ui/label`, `@/lib/actions`
  </action>
  <verify>
- All three files exist and have 'use client' directive
- `npm run build` succeeds with no type errors
- RatingScale imports ToggleGroup + ToggleGroupItem from @/components/ui/toggle-group
- UseAgainToggle imports Switch from @/components/ui/switch
- ScorecardNotesEditor imports useDebouncedCallback from @/lib/hooks/use-debounce
- Grep for `if (!value) return` in rating-scale.tsx confirms deselection guard
  </verify>
  <done>
- RatingScale renders a 1-5 ToggleGroup that auto-saves on click with optimistic UI
- UseAgainToggle renders a Switch that auto-saves Yes(1)/No(0) with optimistic UI
- ScorecardNotesEditor renders a debounced textarea with markdown preview and save status
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ScorecardSection container and integrate into WeekendDetail</name>
  <files>src/components/weekend/scorecard-section.tsx, src/components/weekend/weekend-detail.tsx</files>
  <action>
1. **Create `src/components/weekend/scorecard-section.tsx`** -- Client Component container:

   ```typescript
   'use client';
   ```

   Props: `weekendId: number`, `ratings: Array<{ id: number; criterion: string; rating: number | null; comment: string | null }>`, `scorecardNotes: string | null`.

   Implementation:
   - Build a lookup map from ratings array: `const ratingMap = new Map(ratings.map(r => [r.criterion, r.rating]))`
   - Convert `rating` values to integers using `Math.round()` when reading from the map (DB stores as `real` which may return floats like `3.0`). Use a helper: `const getRating = (key: string) => { const v = ratingMap.get(key); return v != null ? Math.round(v) : null; }`
   - Render section with heading "Scorecard" (h2, same style as other sections: `text-lg font-semibold tracking-tight`)
   - Render three `RatingScale` components:
     - criterion="outcome_quality", label="Outcome Quality", description="How good was the final result?"
     - criterion="time_saved", label="Time Saved", description="How much time did AI save you?"
     - criterion="repeatability", label="Repeatability", description="Could you reproduce this approach?"
   - Render one `UseAgainToggle` component with currentValue from ratingMap
   - Render one `ScorecardNotesEditor` component with `initialNotes={scorecardNotes}`
   - Spacing: `space-y-6` for the section, `space-y-5` for the ratings group, a horizontal rule or extra spacing before notes

2. **Modify `src/components/weekend/weekend-detail.tsx`** to add conditional scorecard rendering:

   Add import for ScorecardSection and Lock icon:
   ```typescript
   import { ScorecardSection } from "@/components/weekend/scorecard-section";
   import { Lock } from "lucide-react";
   ```

   After the existing Notes Editor section (the last section before the closing `</article>`), add the scorecard section with completion gating:

   ```tsx
   {/* Scorecard */}
   {weekend.completedAt ? (
     <ScorecardSection
       weekendId={weekend.id}
       ratings={weekend.scorecardRatings}
       scorecardNotes={weekend.scorecardNotes}
     />
   ) : (
     <section className="space-y-3 opacity-50">
       <div className="flex items-center gap-2">
         <h2 className="text-lg font-semibold tracking-tight">Scorecard</h2>
         <Lock className="h-4 w-4 text-muted-foreground" />
       </div>
       <p className="text-sm text-muted-foreground">
         Complete all core work items to unlock the scorecard.
       </p>
     </section>
   )}
   ```

   The `weekend` prop already includes `scorecardRatings` and `scorecardNotes` because the query was updated in Plan 01. The `WeekendData` type is derived from `getWeekendById` return type, so it automatically includes the new fields.

**Important details:**
- The locked state uses `opacity-50` for the faded/disabled appearance and a `Lock` icon next to the heading
- The locked state text "Complete all core work items to unlock the scorecard" tells the user what action is needed
- `weekend.completedAt` is the gating signal -- it is set by Phase 3's `toggleWorkItem` when all core work items are checked
- `weekend.scorecardRatings` is the array of existing ratings (may be empty for a newly completed weekend)
- `weekend.scorecardNotes` is the scorecard notes string (may be null)
  </action>
  <verify>
- `npm run build` succeeds with no type errors
- `src/components/weekend/scorecard-section.tsx` exists and imports all three rating components
- `src/components/weekend/weekend-detail.tsx` imports ScorecardSection and renders conditionally on completedAt
- Grep for `completedAt` in weekend-detail.tsx confirms the gating logic
- Grep for `Lock` in weekend-detail.tsx confirms the locked state icon
  </verify>
  <done>
- ScorecardSection composes all four rating dimensions plus notes into a cohesive section
- WeekendDetail conditionally renders the scorecard: active for completed weekends, locked/disabled for uncompleted ones
- The locked state shows a Lock icon and explains how to unlock it
- The full Phase 4 feature is wired end-to-end: data flows from query -> page -> detail -> scorecard -> rating components -> Server Actions -> database
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. Visit a completed weekend detail page -- scorecard section appears with all four rating dimensions and notes field
3. Click a 1-5 rating -- it saves immediately (no form submit), persists on page refresh
4. Toggle "Use Again" switch -- it saves immediately, persists on page refresh
5. Type in scorecard notes -- auto-saves after 1 second pause, persists on page refresh
6. Visit an uncompleted weekend -- scorecard section shows locked state with Lock icon and explanatory text
7. Complete all core work items on an uncompleted weekend -- scorecard section unlocks and becomes interactive
</verification>

<success_criteria>
- All four success criteria from the Phase 4 roadmap are met:
  1. Completed weekends show a scorecard with ratings for Outcome Quality (1-5), Time Saved (1-5), Repeatability (1-5), and Use Again (Yes/No)
  2. Scorecard ratings auto-save on change without requiring an explicit save action
  3. Each scorecard includes a free-text field for notes (best prompt, approach, what didn't work) that persists
  4. Uncompleted weekends do not show the scorecard (shown as locked/disabled)
</success_criteria>

<output>
After completion, create `.planning/phases/04-weekly-scorecard/04-02-SUMMARY.md`
</output>
