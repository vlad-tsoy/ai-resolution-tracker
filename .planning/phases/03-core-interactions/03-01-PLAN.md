---
phase: 03-core-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions.ts
  - src/lib/hooks/use-debounce.ts
  - src/components/ui/checkbox.tsx
  - src/components/ui/textarea.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Toggling a work item changes its isCompleted state in the database"
    - "When all core items for a weekend are completed, the weekend's completedAt is set"
    - "When a core item is unchecked, the weekend's completedAt is cleared"
    - "Saving notes persists the text to the weekend's notes column"
    - "The overview page cache is invalidated after a work item toggle"
  artifacts:
    - path: "src/lib/actions.ts"
      provides: "toggleWorkItem and saveNotes Server Actions"
      exports: ["toggleWorkItem", "saveNotes"]
    - path: "src/lib/hooks/use-debounce.ts"
      provides: "useDebouncedCallback hook for auto-save"
      exports: ["useDebouncedCallback"]
    - path: "src/components/ui/checkbox.tsx"
      provides: "shadcn/ui Checkbox component"
    - path: "src/components/ui/textarea.tsx"
      provides: "shadcn/ui Textarea component"
  key_links:
    - from: "src/lib/actions.ts"
      to: "src/db/schema.ts"
      via: "Drizzle update queries on workItems and weekends tables"
      pattern: "update\\(workItems\\)|update\\(weekends\\)"
    - from: "src/lib/actions.ts"
      to: "next/cache"
      via: "revalidatePath for cache invalidation"
      pattern: "revalidatePath"
---

<objective>
Install dependencies, create Server Actions for work item toggling and notes saving, and add the custom debounce hook.

Purpose: Establish the mutation layer (Server Actions + utilities) that interactive components will call. This must exist before Client Components can be wired up.

Output: `src/lib/actions.ts` with `toggleWorkItem` and `saveNotes`, `src/lib/hooks/use-debounce.ts`, shadcn/ui Checkbox and Textarea components, `react-markdown` installed.
</objective>

<execution_context>
@/Users/vladimirtsoy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vladimirtsoy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/db/schema.ts
@src/lib/db.ts
@src/lib/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add shadcn/ui components</name>
  <files>package.json, src/components/ui/checkbox.tsx, src/components/ui/textarea.tsx</files>
  <action>
Install the react-markdown package:
```bash
npm install react-markdown
```

Add shadcn/ui Checkbox and Textarea components:
```bash
npx shadcn@latest add checkbox --yes
npx shadcn@latest add textarea --yes
```

Verify both components exist in `src/components/ui/`.
  </action>
  <verify>
Run `npm ls react-markdown` to confirm installation. Check that `src/components/ui/checkbox.tsx` and `src/components/ui/textarea.tsx` exist.
  </verify>
  <done>react-markdown is in package.json dependencies. Checkbox and Textarea components exist in src/components/ui/.</done>
</task>

<task type="auto">
  <name>Task 2: Create Server Actions and debounce hook</name>
  <files>src/lib/actions.ts, src/lib/hooks/use-debounce.ts</files>
  <action>
**Create `src/lib/actions.ts`** with the `'use server'` directive at the top. Two exported functions:

1. `toggleWorkItem(itemId: number)`:
   - Validate `itemId` with `z.number().int().positive()`
   - Use Drizzle's `not()` operator to atomically toggle `workItems.isCompleted`:
     ```typescript
     const [updated] = await db
       .update(workItems)
       .set({ isCompleted: not(workItems.isCompleted), updatedAt: new Date() })
       .where(eq(workItems.id, id))
       .returning();
     ```
   - If no row returned, return early
   - Query all work items for `updated.weekendId`
   - Filter to core items (`!item.isAdvanced`)
   - If ALL core items are completed AND there is at least one core item, set `weekends.completedAt = new Date()`
   - Otherwise, set `weekends.completedAt = null`
   - Call `revalidatePath('/')` and `revalidatePath(`/weekend/${updated.weekendId}`)`

2. `saveNotes(weekendId: number, notes: string)`:
   - Validate with zod schema: `weekendId` is positive int, `notes` is string max 50000 chars
   - Update the weekend's `notes` and `updatedAt` fields
   - Call `revalidatePath(`/weekend/${weekendId}`)`

Import from:
- `@/lib/db` for `db`
- `@/db/schema` for `workItems`, `weekends`
- `drizzle-orm` for `eq`, `not`
- `next/cache` for `revalidatePath`
- `zod` for validation (import as `z` from `zod`)

**Create `src/lib/hooks/use-debounce.ts`** with a `useDebouncedCallback` hook:
- Takes a callback function and a delay (number, milliseconds)
- Uses `useRef` for the timeout ID and a `callbackRef` to keep the callback current
- `useEffect` cleanup clears the timeout on unmount
- Returns a stable function (via `useCallback` with `[delay]` dependency) that clears previous timeout and sets a new one
- The returned function calls `callbackRef.current` (not the stale closure) when the timeout fires
- This is a Client-side hook (`'use client'` is NOT needed in a hooks file that's imported by client components, but do NOT add `'use server'` either -- leave it as a plain module)

Reference the research file patterns at `.planning/phases/03-core-interactions/03-RESEARCH.md` Example 1 and Example 4 for the exact implementation.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Confirm `src/lib/actions.ts` exports `toggleWorkItem` and `saveNotes`. Confirm `src/lib/hooks/use-debounce.ts` exports `useDebouncedCallback`.
  </verify>
  <done>Server Actions file exists with toggleWorkItem (atomic toggle + weekend completion derivation + revalidation) and saveNotes (validation + persist + revalidation). Debounce hook exists with proper cleanup and stable reference.</done>
</task>

</tasks>

<verification>
1. `npm ls react-markdown` shows react-markdown in dependencies
2. `src/components/ui/checkbox.tsx` and `src/components/ui/textarea.tsx` exist
3. `npx tsc --noEmit` passes (no type errors)
4. `src/lib/actions.ts` has `'use server'` directive and exports both functions
5. `src/lib/hooks/use-debounce.ts` exports `useDebouncedCallback`
</verification>

<success_criteria>
- react-markdown installed
- shadcn/ui Checkbox and Textarea components available
- toggleWorkItem Server Action: atomically toggles work item, derives weekend completion from core items, revalidates both pages
- saveNotes Server Action: validates input, persists notes text, revalidates detail page
- useDebouncedCallback hook: debounces with configurable delay, cleans up on unmount, maintains stable reference
- All TypeScript types are correct (no `any`, proper Drizzle types)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-interactions/03-01-SUMMARY.md`
</output>
